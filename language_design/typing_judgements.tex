% !TeX root = ./main.tex
% chktex-file 1
% chktex-file 46


\begin{mathpar}
	% Mode Switch
	\inferrule*[]
	{ \typecheck{v}{\tyA} }
	{ \typesynth{(v \oftype \tyA)}{\tyA} }

	\inferrule*[]
	{ \typesynth{v}{\tyA'} \\ \tyA = \tyA'}
	{ \typecheck{v}{\tyA} }

	% Term Variable
	\inferrule*[]
	{ (x \oftype \tyA) \in \ctx }
	{ \typesynth{x}{\tyA} }

	% Constant
	\inferrule*[]{ }
	{ \typesynth{\unit}{\unittype} }

	% Integer
	\inferrule*[]{ }
	{ \typesynth{n}{\inttype} }

	% Sums
	\inferrule*[]
	{ \typecheck{v}{\tyA} }
	{ \typecheck{\inleft{} v}{\sumtype{\tyA}{\tyB}} }

	\inferrule*[]
	{ \typecheck{v}{\tyB} }
	{ \typecheck{\inright v}{\sumtype{\tyA}{\tyB}} }

	% Pairs
	\inferrule*[]
	{ \typecheck{v_1}{\tyA} \\ \typecheck{v_2}{\tyB} }
	{ \typecheck{\pair{v_1}{v_2}}{\producttype{\tyA}{\tyB}} }

	\inferrule*[]
	{ \typesynth{v_1}{\tyA} \\ \typesynth{v_2}{\tyB} }
	{ \typesynth{\pair{v_1}{v_2}}{\producttype{\tyA}{\tyB}} }

	% Function
	\inferrule*[]
	{ \typecheck[\ctx, x \oftype \tyA]{c}{\ctyC} }
	{ \typecheck{\fun{x}{c}}{\tyA \to \ctyC} }

	% Handler
	\inferrule*[]
	{	\typecheck[\ctx, x \oftype \tyA]{c_r}{\ctyD} \\
		\respects{h}{\eqE}{\sig}{\ctyD} }
	{\typecheck
		{\handler{h}}
		{\ctype{\tyA}{\sig}{\eqE} \hto \ctyD}
	}

	% Respects

	\inferrule*[]{ }
	{\typecheck{\emptyhcases}{\nil \casesto {\ctyD}} }

	\inferrule*[]
	{\typecheck
		{h}
		{\sig \casesto {\ctyD}}\\
		\typecheck[\ctx, x \oftype \tyA_{\op}, k \oftype \tyB_{\op} \to \ctyD]
		{c_{\op}}
		{\ctyD}\\
		\op \not \in \sig
	}
	{\typecheck
		{h \union \set{\operation{x}{k} \mapsto c_{\op}}}
		{(\sig \union \set{\op \oftype \tyA_{\op} \to \tyB_{\op}}) \casesto {\ctyD}}
	}
\end{mathpar}

%=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

\begin{mathpar}
	% Mode Switch
	\inferrule*[]
	{ \typecheck{c}{\ctyC}}
	{ \typesynth{(c \oftype \ctyC)}{\ctyC} }

	\inferrule*[]
	{ \typesynth{c}{\ctyC'} \\ \ctyC = \ctyC' \\ \text{\todo{effect subtyping?}} }
	{ \typecheck{c}{\ctyC} }

	% Match statements
	\inferrule*[]
	{ \typesynth{v}{\sumtype{\tyA}{\tyB}} \\
		\typecheck[\ctx, x \oftype \tyA]{c_l}{\ctyC} \\
		\typecheck[\ctx, x \oftype \tyB]{c_r}{\ctyC} }
	{ \typecheck{\match{v} \sumcases{x}{c_l}{x}{c_r} }{\ctyC} }

	\inferrule*[]
	{ \typesynth{v}{\producttype{\tyA}{\tyB}} \\
		\typesynth[\ctx, x \oftype \tyA, y \oftype \tyB]{c}{\ctyC} }
	{ \typesynth{\match{v} \prodcases{x}{y}{c} }{\ctyC} }

	% Function application
	\inferrule*[]
	{ \typesynth{v_1}{\tyA \to \ctyC} \\
		\typecheck{v_2}{\tyA}	}
	{ \typesynth{\apply{v_1}{v_2}}{\ctyC} }

	% Return
	\inferrule*[]
	{ \typesynth{v}{\tyA} }
	{ \typesynth{\return{v}}{\ctype{\tyA}{\nil}{\nil}} }

	% Operation
	\inferrule*[]
	{ (\op \oftype \tyA_{\op} \to \tyB_{\op}) \in \sig \\
		\typecheck{v}{\tyA_{\op}} \\
		\typecheck[\ctx, y \oftype \tyB_{\op}]{c}{\ctype{\tyA}{\sig}{\eqE}} }
	{ \typecheck{\operation{v}{y.c}}{\ctype{\tyA}{\sig}{\eqE}} }

	% Do-bind
	\inferrule*[]
	{ \typesynth{c_1}{\ctype{\tyA}{\sig}{\eqE}} \\
		\typecheck[\ctx, x \oftype \tyA]{c_2}{\ctype{\tyB}{\sig}{\eqE}} \\
		\text{\todo{effect subtyping?}} }
	{ \typecheck{\dobind{x}{c_1}{c_2}}{\ctype{\tyB}{\sig}{\eqE}} }

	% Handling
	\inferrule*[]
	{ \typesynth{v}{\ctyC \hto \ctyD} \\
		\typecheck{c}{\ctyC} }
	{ \typesynth{\withhandle{v}{c}}{\ctyD} }

\end{mathpar}
